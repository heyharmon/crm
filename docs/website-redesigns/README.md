# Website Redesign Detection

Tracks major homepage redesigns per organization by querying the Internet Archive CDX API and surfacing the resulting history in the CRM UI.

## Handling Wayback “Noise”

Wayback crawls often alternate between full HTML pages and tiny responses generated by web application firewalls or redirect stubs. Those small captures have unique digests and previously reset our persistence clocks, causing the detector to miss modern redesigns. We now:

-   Inspect each collapsed digest row’s HTTP status, mimetype, and payload size (via `statuscode`, `mimetype`, and `length` from the CDX API).
-   Keep only `200` responses with `text/html` (all configurable in `config/waybackmachine.php`) and discard captures whose payload is below the `min_payload_bytes` threshold (10 KB by default).
-   Run the persistence heuristic on the cleaned timeline, which mirrors real homepage changes instead of alternating challenge pages.

## Data Model

-   **organization_website_redesigns**: stores one row per major digest change (Wayback timestamp, digest hash, and persistence window in days). Rows are refreshed each time the detection job runs.
-   **organizations.last_major_redesign_at**: cached date of the most recent major redesign to support lightweight list views and filters.

## Backend Flow

1. **DetectWebsiteRedesignJob** (`app/Jobs/DetectWebsiteRedesignJob.php`)
    - Accepts an `organization_id` and skips work if the record or website URL is missing.
    - Calls `WebsiteRedesignDetector` to fetch CDX snapshots and identify digest windows that remain stable for the configured duration (`config/waybackmachine.php`).
    - Replaces existing redesign rows for the organization, then updates `last_major_redesign_at` using the newest detected event.
2. **WebsiteRedesignDetector** (`app/Services/WebsiteRedesignDetector.php`)
    - Normalizes the organization’s hostname, fetches collapsed digest rows via the CDX API, and parses timestamps.
    - Filters out noisy captures (non-200 responses, non-HTML mimetypes, and payloads smaller than the configured byte threshold) so that WAF challenges and placeholder pages do not look like real redesigns.
    - Flags “major” redesigns when the digest remains unchanged for the configured minimum number of days (default 120). Only the most recent N events (default 5) are kept.
3. **OrganizationController@show** eagerly loads the redesign rows (newest first) so the frontend can render the timeline alongside the organization profile.

## Frontend Updates

-   **OrganizationDetail panel** now shows the last redesign date plus a list of detected events, including how long each digest version stayed stable.
-   **Grid/Table views** both show the cached “Last redesign” date when present, giving users quick insight while browsing.

## Operations

-   Tune detection thresholds via `config/waybackmachine.php` (endpoint, minimum persistence days, event cap, CDX filtering rules, and payload threshold).
-   Schedule or manually dispatch `DetectWebsiteRedesignJob` whenever organization websites change or on a periodic cadence to refresh redesign insights.
